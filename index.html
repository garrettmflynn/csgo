<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSGO Server Test</title>
</head>
<body>
    <h1 id="appname">No Game Specified</h1>
    <p><b id="username">Unknown Username</b>  <sub id="steamid">-</sub></p>

    <ul></ul>
</body>
<script>
    var source = new EventSource('/events');

    const appNameElement = document.getElementById('appname')
    const usernameElement = document.getElementById('username')
    const steamIDElement = document.getElementById('steamid')

    const ul = document.querySelector('ul')

    function addListItem(html) {
        ul.insertAdjacentHTML('beforeend', `<li>${html}</li>`)
    }

    function handleSSEEvent(event) {
        const info = JSON.parse(event.data)
        const { provider, ...updates } = info

        // Update the Provider Information
        if (provider) {
            const { name, steamid, appid, timestamp, version } = provider
            appNameElement.innerText = name
            steamIDElement.innerText = steamid
        }
        // const events = ["gameMap", "gamePhase", "gameRounds", "gameCTscore", "gameTscore", "roundWins", "player", "roundPhase", "roundWinTeam", "bombState", "bombTimeStart", "bombExploded", "bombTimeLeft"]

        ul.insertAdjacentHTML('beforeend', `<h4>New Update</h4>`)

        Object.entries(updates).forEach(([name, value]) => {

            if (name === 'player') {
                username.innerText = value.name
            }

            addListItem(`<small>${name} - ${JSON.stringify(value)}</small>`)
        })
    }

    function onOpen(event) {
        addListItem(`<p><b>Event source opened!</b></p>`)
    }

    // source.addEventListener('progress', handleSSEEvent, false);
    source.addEventListener('message', handleSSEEvent);

    source.addEventListener('error', function(event) {
        console.error("Failed to connect to event stream.");
    }, false);

    source.addEventListener("open", onOpen);

    // fetch('/events').then(res => addListItem(`<p><b>events finished!</b></p>`))
</script>
</html>
